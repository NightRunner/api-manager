<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>action test</title>
    <link href="plugins/bootstrap/css/bootstrap.css" rel="stylesheet"/>
    <link href="plugins/jsonview/css/jquery.jsonview.css" rel="stylesheet" />
    <script src="common/js/jquery-3.3.1.min.js"></script>
    <script src="plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="plugins/mock/mock.js"></script>
    <script src="plugins/jsonview/js/jquery.jsonview.js"></script>
    <script src="common/js/namespace.js"></script>
    <script src="common/js/util.js"></script>
    <script src="common/ui/jquery.chosen.js"></script>
    <script src="common/ui/jquery.param.js"></script>
    <script src="common/js/jquery.md5.js"></script>
</head>
<body>

<div class="container">
    <div class="row">
        <div id="requestHead" style="width: 100%;">
            <p style="text-align: center;font-family: Microsoft YaHei; font-size:larger; background-color: #9fcdff;margin-bottom: 0px;">请求头参数</p>
        </div>
    </div>
    <div class="row">
        <div id="requestParam" style="width: 100%; overflow: auto;">
            <p style="text-align: center;font-family: Microsoft YaHei; font-size:larger; background-color: #9fcdff;margin-bottom: 0px;">请求参数</p>
        </div>
    </div>
    <div class="row">
        <div class="input-group col-6" style="padding-left: 0px;">
            <label>接口地址：</label>
            <input name="testRequestUrl" class="form-control" style="font-family: Microsoft YaHei;font-size: 15px;"></input>
        </div>
        <div class="input-group col-4" style="padding-left: 0px;">
            <label>接口类型：</label>
            <select name="testRequestType" class="form-control"></select>
        </div>
        <div class="input-group col-2">
            <button id="sendRequest" class="btn btn-info">发送请求</button>
        </div>
        <hr style="width: 100%;">
    </div>
    <div class="row">
        <div class="col-2" style="padding-left: 0px;">
            <a id="requestJsonFormatLink" style="color:#17a2b8; cursor: pointer;">格式化</a>
        </div>
        <div class="col-2" style="padding-left: 0px;">
            <a id="requestJsonRowLink" style="color:#17a2b8; cursor: pointer;">行模式</a>
        </div>
        <hr style="width: 100%; margin-top: 1px;">
    </div>
    <div class="row">
        <div>
            <label>请求数据：</label>
        </div>
    </div>
    <div class="row">
        <div id="requestJson"></div>
        <textarea id="requestJsonArea" class="form-control" style="display: none; font-family: 宋体;font-size: 14px; height: 40px;"></textarea>
        <hr style="width: 100%;">
    </div>

    <div class="row">
        <div class="col-2" style="padding-left: 0px;">
            <a id="responseJsonFormatLink" style="color:#17a2b8; cursor: pointer;">格式化</a>
        </div>
        <div class="col-2" style="padding-left: 0px;">
            <a id="responseJsonRowLink" style="color:#17a2b8; cursor: pointer;">行模式</a>
        </div>
        <hr style="width: 100%; margin-top: 1px;">
    </div>
    <div class="row">
        <div>
            <label>返回数据：</label>
        </div>
    </div>
    <div class="row">
        <div id="responseJson"></div>
        <textarea id="responseJsonArea" class="form-control" style="display: none; font-family: 宋体;font-size: 14px; height: 100px;"></textarea>
    </div>
    <p></p>
</div>

<script>
    var headOptions = {
        container: '#requestHead',
        headers: [
            {text: '操作', width: '5%'},
            {text: '名称', width: '15%'},
            {text: '含义', width: '20%'},
            {text: '类型', width: '20%'},
            {text: '默认值', width: '20%'}
        ],
        fields: [
            {name: 'name', type: 'input'},
            {name: 'desc', type: 'input'},
            {
                name: 'type', type: 'select', options: {
                    width: '100%',
                    height: '100%',
                    blank: false,
                    optionField: {value: 'k', text: 'v'},
                    url: '/apimanager/meta/findMeta',
                    params: {metaId: 1}
                }
            },
            {name: 'defaultVal', type: 'input'}
        ],
        footBtn: [
            {
                type: 'add', text: '添加参数', fn: function (row) {
                }
            }
        ]
    };

    var requestOptions = {
        container: '#requestParam',
        headers: [
            {text: '操作', width: '5%'},
            {text: '名称', width: '15%'},
            {text: '含义', width: '20%'},
            {text: '类型', width: '20%'},
            {text: '规则', width: '20%'},
            {text: '默认值', width: '20%'}
        ],
        fields: [
            {name: 'name', type: 'input'},
            {name: 'desc', type: 'input'},
            {
                name: 'type', type: 'select', options: {
                    width: '100%',
                    height: '100%',
                    blank: false,
                    optionField: {value: 'k', text: 'v'},
                    url: '/apimanager/meta/findMeta',
                    params: {metaId: 1}
                }
            },
            {name: 'rule', type: 'input'},
            {name: 'defaultVal', type: 'input'}
        ],
        footBtn: [
            {
                type: 'add', text: '添加参数', fn: function (row) {
                }
            }
        ]
    };

    var requestTypeOptions = {
        selector: '[name=testRequestType]',
        width: '70%',
        params: {metaId: 2},
        optionField: {value: 'k', text: 'v'},
        url: '/apimanager/meta/findMeta'
    };

    // 页面组件初始化
    api.ui.chosenSelect(requestTypeOptions);
    var headParam = api.ui.param(headOptions);
    var requestParam = api.ui.param(requestOptions);

    $('#sendRequest').on('click', function () {
        var requestMockTemplate = api.util.buildMockTemplate(requestParam.toData());
        var headMockTemplate = api.util.buildMockTemplate(headParam.toData());
        var requestData = Mock.mock(requestMockTemplate), headData = Mock.mock(headMockTemplate);
        var requestDataStr = JSON.stringify(requestData), headDataStr = JSON.stringify(headData);
        $('#requestJson').JSONView(requestDataStr);
        $('#requestJsonArea').val(requestDataStr);

        var requestBody = {};
        requestBody['requestType'] = $('[name=testRequestType]').val();
        requestBody['requestUrl'] = $('[name=testRequestUrl]').val();
        requestBody['requestHeadData'] = headDataStr;
        requestBody['requestData'] = requestDataStr;
        $.ajax({
            url: api.util.getUrl('apimanager/tester/send'),
            type: 'POST',
            contentType: 'application/json;charset=UTF-8', //解决415问题
            data: JSON.stringify(requestBody),//解决400问题
            dataType: 'json',
            success: function (result) {
                var data = result.data, dataStr = JSON.stringify(data);
                $('#responseJsonArea').val(dataStr);
                $('#responseJson').JSONView(dataStr);
            }
        });
    });
    
    $('#requestJsonFormatLink').on('click', function () {
        $('#requestJson').css('display', '');
        $('#requestJsonArea').css('display', 'none');
    });

    $('#requestJsonRowLink').on('click', function () {
        $('#requestJson').css('display', 'none');
        $('#requestJsonArea').css('display', '');
    });

    $('#responseJsonFormatLink').on('click', function () {
        $('#responseJson').css('display', '');
        $('#responseJsonArea').css('display', 'none');
    });

    $('#responseJsonRowLink').on('click', function () {
        $('#responseJson').css('display', 'none');
        $('#responseJsonArea').css('display', '');
    });
</script>
</body>
</html>